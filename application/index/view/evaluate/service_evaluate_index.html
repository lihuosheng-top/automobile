<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 屏幕适配 -->
    <script src="__STATIC__/index/js/adaptation.js"></script>
    <link rel="stylesheet" href="__STATIC__/index/css/common.css">
    <link rel="stylesheet" href="__STATIC__/index/js/plugin/layui/css/layui.css">
    <title>服务-发表评价</title>
    <style>
        html, body{background-color: #fff;}
        .header{position: relative; height: .88rem; background-color: #f9f9f9;}
        .icon-back{position: absolute;left: .2rem;top: 50%;width: .25rem;   height: .43rem;margin-top: -.22rem;background-position: -.5rem -.5rem;}
        .header h3{width: 100%;height: 100%;text-align: center;line-height: .88rem;font-size: .36rem;color: #333;font-weight: normal;}
        .publish-btn{position: absolute; right: .2rem; top: 50%; transform: translateY(-50%); border: 0; background-color: transparent; color: #f85d26; outline: none;width: 1rem; height: .6rem; font-size: .3rem;}
        .goods-evaluate{display: flex; align-items: center; padding: 0 .2rem; border-bottom: 1px solid #eee; height: 1rem;}
        .goods-img{width: .7rem; height: .7rem; overflow: hidden; margin-right: .2rem;}
        .goods-img img{width: 100%; height: 100%;}
        .ms{color: #666; margin-right: .5rem;}
        .star span{color: #999;}
        .evaluate-txt{margin-bottom: .2rem;}
        .evaluate-txt textarea{width: 100%; height: 2rem; padding: .2rem; box-sizing: border-box; border: 0; font-size: .3rem; resize: none;}
        .vi-camera{padding: 0 .2rem; display: flex; flex-wrap: wrap; margin-bottom: .3rem;}
        .switch-span{position: relative; display: block; width: 1.25rem; height: 1.25rem; border: 1px dashed #ccc; text-align: center; line-height: 2.1rem; color: #ccc; font-size: .24rem;}
        .switch-span::before{position: absolute; left: 50%; top: 50%; transform: translate(-50%, -60%); content: ''; background: url(__STATIC__/index/image/camera.png) no-repeat; width: .72rem; height: .72rem; background-size: 100%;}
        .switch-span input{position: absolute; top: 0;left: 0; width: 100%;height: 100%; opacity: 0;}
        .upload-item{position: relative; width: 1.25rem; height: 1.25rem; margin-right: .3rem;}
        .upload-item img{width: 100%; height: 100%;}
        .upload-item .del-img{position: absolute; top: -6px; right: -6px; font-size: .3rem; color: #fff; background-color: rgba(0, 0, 0, .6); border: 0; outline: none; width: .3rem; height: .3rem; border-radius: 50%; text-align: center; line-height: .3rem;}
        .shop-evaluate{border-top: 5px solid #f2f2f2; padding: .25rem .2rem 0;}
        .shop-eva-title{margin-bottom: .35rem;}
        .icon-shop{display: inline-block;width: .3rem;height: .29rem;background-position: -5.6rem -1rem;vertical-align: text-bottom;}
        .on-time{margin-bottom: .2rem;}
        .on-time input{vertical-align: middle; margin-left: .35rem;}
        .service{margin-left: .35rem;}
        .logistics{margin-left: .35rem;}
        .evaluation-subject{border-bottom: 1px solid #eee;}
    </style>
</head>
<body>
    <div class="wrapper">
        <header class="header">
            <a href="order_service_wait_evaluate" class="spr icon-back"></a>
            <h3>发表评价</h3>
            <button class="publish-btn">发布</button>
        </header>
        <!-- <div class="evaluation-subject">
            <div class="goods-evaluate">
                <div class="goods-img">
                    <img src="__STATIC__/index/image/15.jpg">
                </div>
                <p class="ms">描述相符</p>
                <div class="star"></div>
            </div>
            <div class="evaluate-txt">
                <textarea placeholder="宝贝满足你的期待吗？说说它的优点和美中不足的地方吧"></textarea>
            </div>
            <div class="vi-camera">
                <div class="upload-item">
                    <img src="__STATIC__/index/image/15.jpg">
                    <button class="del-img">×</button>
                </div>
                <span class="switch-span">添加图片
                    <input type="file" multiple id="upload">
                </span>
            </div>
        </div> -->
        <div class="shop-evaluate">
            <div class="shop-eva-title">
                <i class="spr icon-shop"></i>店铺评分
            </div>
            <div class="service-eval">
                服务态度
                <div class="service star" id="service"></div>
            </div>
            <div class="logistics-eval">
                服务技术
                <div class="logistics star" id="logistics"></div>
            </div>
        </div>
    </div>
    <script src="__STATIC__/index/js/plugin/jquery.js"></script>
    <script src="__STATIC__/index/js/plugin/layer.js"></script>
    <script src="__STATIC__/index/js/plugin/layui/layui.js"></script>
    <script>
        // 初始化star
        var starArr = [];
        function initStar(){
            layui.use(['rate'], function(){
                var rate = layui.rate;
                layui.each($('.star'), function(idx, elem){
                    starArr[idx] = 5;
                    rate.render({
                        elem: elem,
                        value: 5,
                        text: true,
                        setText: function(val){
                            var arrs = {
                                '1': '很差',
                                '2': '差',
                                '3': '一般',
                                '4': '好',
                                '5': '很好',
                            };
                            this.span.text(arrs[val]);
                        },
                        choose: (value) => {
                            starArr[idx] = value;
                            // console.log(starArr);
                        }
                    })
                })
            })
        }
        // 获取商品信息
        $.ajax({
            url: 'service_evaluate_index',
            type: 'POST',
            dataType: 'JSON',
            success: function(res){
                console.log(res);
                if(res.status == 1){
                    var str = '';
                    $.each(res.data, function(idx, val){
                        str += `<div class="evaluation-subject" id="`+val.id+`">
                                    <div class="goods-evaluate">
                                        <div class="goods-img">
                                            <img src="uploads/`+val.service_goods_image+`">
                                        </div>
                                        <p class="ms">描述相符</p>
                                        <div class="star"></div>
                                    </div>
                                    <div class="evaluate-txt">
                                        <textarea placeholder="宝贝满足你的期待吗？说说它的优点和美中不足的地方吧"></textarea>
                                    </div>
                                    <div class="vi-camera">
                                        <span class="switch-span">添加图片
                                            <input type="file" multiple id="upload-`+idx+`">
                                        </span>
                                    </div>
                                </div>`
                    })
                    $('.header').after(str);
                    // 初始化star
                    initStar();
                    // 上传图片
                    $('.switch-span').on('change', 'input', function(){
                        var inputElem = $(this)[0];
                        var switchSpan = $(this).parent();
                        var id = $(this).parents('.evaluation-subject').attr('id');
                        changeEvent(inputElem, switchSpan, id);
                        // console.log(filesObj)
                    })
                }
            },
            error: function(){
                console.log('error');
            }
        })
        var filesObj = {};
        function changeEvent(inputElem, clickObj, id){
            var imgArrDom = [];
            var str = '';
            var len =  inputElem.files.length;
            // // 限制上传图片
            var uploadItemLen = $(clickObj).siblings('.upload-item').length;
            if(uploadItemLen + len <= 4){
                // 第一次实例化数组
                if(filesObj[id] === undefined){
                    filesObj[id] = new Array();
                }
                for(var i = 0; i < len; i++){
                    // 存图片地址
                    imgArrDom.push(getObjectURL(inputElem.files[i]));
                    // 把files用id区分开插入
                    filesObj[id].push(inputElem.files[i]);
                }
                $.each(imgArrDom, function(idx, val){
                    str += `<div class="upload-item">
                                <img src="`+val+`">
                                <button class="del-img">×</button>
                            </div>`
                })
                $(clickObj).before(str);
            }else{
                layer.open({
                    skin: 'msg',
                    content: '最多上传4张图片',
                    time: 1
                })
            }
            // 删除图片
            $('.upload-item').on('click', '.del-img', function(){
                var $index = $('.del-img').index($(this));
                filesObj[id].splice($index, 1);
                // console.log(filesObj)
                $(this).parent().remove();
            })
        }
        // 在浏览器上预览本地图片
        function getObjectURL(file) {
            var url = null;
            if(window.URL != undefined) { // mozilla(firefox)
                url = window.URL.createObjectURL(file);
            } else if(window.webkitURL != undefined) { // webkit or chrome
                url = window.webkitURL.createObjectURL(file);
            }
            return url;
        }
        // 发布
        var formData = new FormData();
        $('.publish-btn').click(function(){
            var orderId = [];
            var evaluationSubjectArr = $('.evaluation-subject');
            // 商品id
            $.each(evaluationSubjectArr, function(idx, val){
                orderId.push(val.id);
            })
            // 用户评价内容
            var evaluateContent = [];
            $.each($('textarea'), function(idx, val){
                evaluateContent.push(val.value);
            })
            $.each(evaluateContent, function(idx, val){
                formData.append('evaluateContent[]', val);
            })
            var idArr = [];
            $.each($('.evaluation-subject'), function(idx, val){
                idArr.push(val.id);
            })
            $.each(idArr, function(idx, val){
                if($.isEmptyObject(filesObj)){
                    formData.append('filesArr[]', null);
                }else{
                    $.each(filesObj[val], function(index, value){
                        console.log(value);
                        formData.append('filesArr'+val+'[]', value);
                    })
                }
            })
            $.each(orderId, function(idx, val){
                formData.append('orderId[]', val);
            })
            $.each(starArr, function(idx, val){
                formData.append('starArr[]', val);
            })

            $.ajax({
                url: 'evaluate_service_add',
                type: 'POST',
                dataType: 'JSON',
                processData: false,
                contentType: false,
                data: formData,
                success: function(res){
                    console.log(res);
                    if(res.status == 1){
                        layer.open({
                            skin: 'msg',
                            content: '发布成功',
                            time: 1
                        })
                        setTimeout(function(){
                            location.href = 'order_service_wait_evaluate';
                        }, 1100)
                    }
                },
                error: function(){
                    console.log('error');
                }
            })
        })
    </script>
</body>
</html>