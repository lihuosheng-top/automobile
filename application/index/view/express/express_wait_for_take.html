<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 屏幕适配 -->
    <script src="__STATIC__/index/js/adaptation.js"></script>
    <link rel="stylesheet" href="__STATIC__/index/css/common.css">
    <title>待取货</title>
    <style>
        html, body{background-color: #f2f2f2;}
        .courier-bg{height: 3.3rem; background-color: #3169f6; display: flex; align-items: center;}
        .courier-bg .avatar{margin-left: .5rem; width: 1rem; height: 1rem; border-radius: 50%; overflow: hidden;}
        .courier-bg .avatar img{width: 100%; height: 100%;}
        .info{display: flex; flex-direction: column; line-height: normal; margin-left: .3rem;}
        .info span{color: #fff; font-size: .3rem;}
        .status-bar{background-color: #fff; height: 1.2rem; border-radius: .15rem; margin-top: -.8rem; display: flex; align-items: center; justify-content: space-around; box-shadow: 0 1px 5px 0 rgba(220, 220, 220, .6); margin-bottom: .2rem;}
        .status-bar .status-a{position: relative; font-size: .3rem; color: #333;}
        .status-bar .status-on{color: #3169f6;}
        .status-bar .status-on::after{position: absolute; bottom: -0.34rem; left: 0; content: ' '; border: 1px solid #3169f6; width: 100%;}
        .order-item{padding: .3rem .2rem; background-color: #fff; width: 7.2rem; margin: 0 auto .3rem; border-radius: .15rem; box-sizing: border-box;}
        .distance-container{display: flex; align-items: center; justify-content: space-around; border-bottom: 1px solid #eee; padding-bottom: .3rem; margin-bottom: .2rem;}
        .distance-container i{display: inline-block; width: .44rem; height: .5rem;}
        .distance-container i.icon-me{background-position: -4.55rem -.35rem;}
        .distance-container i.icon-get{background-position: -5.05rem -.35rem;}
        .distance-container i.icon-send{background-position: -5.55rem -.35rem;}
        .distance-container .distance-box{font-size: .24rem; color: #999;}
        .address-container{margin-bottom: .3rem;}
        .get-goods{display: flex; justify-content: space-around; line-height: normal;}
        .get-goods>span{font-size: .32rem; color: #ff0600; margin-right: .2rem;}
        .get-goods .shop-name a{font-size: .32rem; color: #333;}
        .get-goods div{display: flex; flex-direction: column; line-height: normal; flex: 1;}
        .get-goods .shop-address{font-size: .28rem; color: #999;}
        .get-goods .shop-phone{display: block; width: .94rem; height: .94rem; background-position: .05rem -4.15rem}
        .send-goods{display: flex; justify-content: space-around; align-items: center; line-height: normal;}
        .send-goods span:first-of-type{font-size: .32rem; color: #09b10d; margin-right: .2rem;}
        .send-goods .send-address{flex: 1; font-size: .32rem;}
        .send-goods .send-address a{color: #333;}
        .send-goods .customer-phone{display: block; width: .94rem; height: .94rem; background-position: .05rem -5.05rem}
        .time-container{display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;}
        .time-container>span{border: 1px solid #39a3f5; font-size: .24rem; color: #678;padding: 0 .15rem; border-radius: .3rem; height: .4rem; margin-bottom: .2rem;}
        .button-container button{width: 100%;height: .8rem; border-radius: .1rem; border: 0; background-color: #3169f6; font-size: .3rem; color: #fff; outline: none;}

        .header-container{background-color: #3169f6; display: flex; align-items: center; justify-content: flex-end; padding: .1rem 0;}
        .set{width: .49rem;height: .46rem;background-position: -5.95rem -.95rem; margin-right: .3rem;}
        .message{width: .54rem;height: .48rem;background-position: -.8rem .05rem; margin-right: .3rem;}
    </style>
</head>
<body>
    <div class="container">
        <header class="header-container">
            <!-- <a href="javascript:;" class="spr message"></a> -->
            <a href="express_setting" class="spr set"></a>
        </header>
        <div class="courier-bg">
            <div class="avatar">
                <img src="__STATIC__/index/image/avatar.png">
            </div>
            <div class="info">
                <span class="name"></span>
                <span class="phone"></span>
            </div>
        </div>
        <div class="status-bar">
            <a href="express_wait_for_order" class="status-a">待接单</a>
            <a href="express_wait_for_take" class="status-a status-on">待取货</a>
            <a href="express_distribution" class="status-a">配送中</a>
            <a href="express_completed" class="status-a">已完成</a>
        </div>
        <div class="order-container">
            <!-- <div class="order-item">
                <div class="address-container">
                    <div class="get-goods">
                        <span>取：</span>
                        <div>
                            <span class="shop-name">德鹏汽车维修店</span>
                            <span class="shop-address">深圳市福田区中电信息大厦</span>
                        </div>
                        <a href="javascript:;" class="spr shop-phone"></a>
                    </div>
                    <div class="send-goods">
                        <span>送：</span>
                        <span class="send-address">深圳市福田区中电信息大厦</span>
                        <a href="javascript:;" class="spr customer-phone"></a>
                    </div>
                </div>
                <div class="time-container">
                    <span class="order-time">下单时间：<span>12-17 19:00</span></span>
                    <span class="accept-time">预计送达时间：<span>12-17 19:00</span></span>
                </div>
                <div class="button-container">
                    <button>我已取货</button>
                </div>
            </div> -->
        </div>
    </div>
    <script src="__STATIC__/index/js/plugin/jquery.js"></script>
    <script src="__STATIC__/index/js/plugin/layer.js"></script>
    <script>
        $.ajax({
            url: 'express_wait_for_take',
            type: 'POST',
            dataType: 'JSON',
            success: function(res){
                console.log(res);
                if(res.status == 1){
                    var data = res.data;
                    $('.info .name').text(data.delivery_data[0].name);
                    $('.info .phone').text(data.delivery_data[0].number);
                    var str = '';
                    $.each(data.express, function(idx, val){
                        str += `<div class="order-item">
                                    <div class="address-container">
                                        <div class="get-goods">
                                            <span>取：</span>
                                            <div>
                                                <span class="shop-name" data-orderId="`+val.order_id+`">`+val.store_name+`</span>
                                                <span class="shop-address">`+val.store_address+`</span>
                                            </div>
                                            <i class="navigation-ex" data-lat="`+val.latitude+`" data-lng="`+val.longitude+`"></i>
                                            <a href="javascript:Android.call('`+val.store_phone+`');" class="spr shop-phone"></a>
                                        </div>
                                        <div class="send-goods">
                                            <span>送：</span>
                                            <span class="send-address" data-orderId="`+val.order_id+`">`+val.user_order_address+`</span>
                                            <i class="navigation-ex"></i>
                                            <a href="javascript:Android.call('`+val.user_order_phone+`');" class="spr customer-phone"></a>
                                        </div>
                                    </div>
                                    <div class="time-container">
                                        <span class="order-time">下单时间：<span>`+timetrans(val.order_create_time)+`</span></span>
                                        <span class="accept-time">预计送达时间：<span>宝贝正在路上，请您耐心等候</span></span>
                                    </div>
                                    <div class="button-container">
                                        <button class="my-btn">我已取货</button>
                                    </div>
                                </div>`
                    })
                    $('.order-container').append(str);
                    // 去高德地图
                    $('.navigation-ex').click(function(){
                        if($(this).attr('data-lat')){
                            var lat = $(this).attr('data-lat'),
                                lng = $(this).attr('data-lng'),
                                name = $(this).parents('.get-goods').find('.shop-name').text();
                            Android.openGdMap(lat, lng, name);
                        }else{
                            var destination = $(this).siblings('.send-address').text();
                            AMap.plugin('AMap.Geocoder', function () {
                                var geocoder = new AMap.Geocoder({
                                    // city 指定进行编码查询的城市，支持传入城市名、adcode 和 citycode
                                    // city: '010'
                                })
                                geocoder.getLocation(destination, function (status, result) {
                                    if (status === 'complete' && result.info === 'OK') {
                                        // result中对应详细地理坐标信息
                                        var lat = result.geocodes[0].location.lat,
                                            lng = result.geocodes[0].location.lng;
                                        Android.openGdMap(lat, lng, destination);
                                    }else{
                                        layer.open({
                                            skin: 'msg',
                                            content: '导航失败，请电话联系用户',
                                            time: 1.5
                                        })
                                    }
                                })
                            })
                        }
                    })
                    $('.order-item').on('click', '.my-btn', function(){
                        var deliveryId = data.delivery_data[0].id;
                        var $index = $('.my-btn').index($(this));
                        var thisData = data.express[$index];
                        layer.open({
                            content: '已取到货物？',
                            btn: ['确定', '取消'],
                            yes: function (index) {
                                layer.close(index);
                                console.log(data.express[$index]);
                                $.ajax({
                                    url: 'express_order_get',
                                    type: 'POST',
                                    dataType: 'JSON',
                                    data: {
                                        'user_order_phone': thisData.order_user_number,
                                        'store_phone': thisData.store_number,
                                        'order_id': thisData.order_id,
                                        'delivery_id': deliveryId,
                                        'status': 2,
                                        'user_order_address': thisData.order_address,
                                        'store_address': thisData.store_address,
                                        'order_create_time': thisData.order_create_time,
                                        'store_name': thisData.store_name,
                                        'parts_order_number': thisData.parts_order_number,
                                        'store_id': thisData.store_id,
                                        'id': thisData.id
                                    },
                                    success: function(res){
                                        console.log(res);
                                        if(res.status == 1){
                                            location.reload();
                                        }
                                    },
                                    error: function(){
                                        console.log('error');
                                    }
                                })
                            }
                        });
                    })
                    // 查看详情
                    $('.shop-name').add('.send-address').click(function(){
                        var orderId = $(this).attr('data-orderId');
                        $.ajax({
                            url: 'express_detail',
                            type: 'POST',
                            dataType: 'JSON',
                            data: {
                                order_id: orderId
                            },
                            success: function(res){
                                console.log(res);
                                if(res.status == 1){
                                    location.href = 'express_detail?orderId='+orderId+'&status='+1;
                                }
                            },
                            error: function(res){
                                console.log(res.status, res.statusText);
                            }
                        })
                    })
                }
                if(res.status == 0){
                    var data = res.data;
                    $('.info .name').text(data[0].name);
                    $('.info .phone').text(data[0].number);
                }
            },
            error: function(){
                console.log('error');
            }
        })
        function timetrans(date){
            var date = new Date(date*1000);//如果date为13位不需要乘1000
            var Y = date.getFullYear() + '-';
            var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
            var D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + ' ';
            var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
            var m = (date.getMinutes() <10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
            var s = (date.getSeconds() <10 ? '0' + date.getSeconds() : date.getSeconds());
            return Y+M+D+h+m+s;
        }
    </script>
</body>
</html>